var rebateurl ={"w_1":"http:\/\/cps.youmai.com\/track.php?site_id=131499&aid=2352&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_2":"{url}?tag=it168-doc-wz-23","w_3":"http:\/\/p.yiqifa.com\/c?s=d077f8dd&w=515194&c=17532&i=41052&l=0&e=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_4":"{url}?cmpid=ad_it168_hangqingwz_1_2_1_5_201604_o_o_o","w_5":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=337&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_9":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=612&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_16":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=450&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_20":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=387&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_28":"http:\/\/g.yiqifa.com\/gc?w=515194&u=213287&e=a{channelid}b{pageid}c{blockid}d{otherid}&c=6665&v=151006&i=22683&t={url}","w_29":"http:\/\/g.yiqifa.com\/gc?w=515194&u=213287&e=a{channelid}b{pageid}c{blockid}d{otherid}&c=6600&v=136552&i=21642&t={url}","w_30":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=561&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_31":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=64&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_32":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=85&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_33":"http:\/\/a.okhqb.com\/plus\/cps_track.php?siteid=it168&src=emar&e=a{channelid}b{pageid}c{blockid}d{otherid}&channel=cps&cid=168&wi=ndgwmdb8dgvzda==&url={url}","w_34":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=58&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_35":"http:\/\/p.yiqifa.com\/c?s=7477ea89&w=515047&c=5532&i=13082&l=0&e=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_36":"http:\/\/g.yiqifa.com\/gc?w=515194&u=213287&e=a{channelid}b{pageid}c{blockid}d{otherid}&c=6320&v=53213&i=18262&t={url}","w_37":"http:\/\/g.yiqifa.com\/gc?w=515194&u=213287&e=a{channelid}b{pageid}c{blockid}d{otherid}&c=4923&v=51189&i=8062&t={url}","w_39":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=58&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_41":"http:\/\/g.yiqifa.com\/gc?w=515194&u=213287&e=a{channelid}b{pageid}c{blockid}d{otherid}&c=6226&v=96047&i=17402&t={url}","w_42":"http:\/\/g.yiqifa.com\/gc?w=515194&u=213287&e=a{channelid}b{pageid}c{blockid}d{otherid}&c=5330&v=71752&i=21823&t={url}","w_43":"http:\/\/g.yiqifa.com\/gc?w=515194&u=213287&e=a{channelid}b{pageid}c{blockid}d{otherid}&c=4744&v=46651&i=7162&t={url}","w_45":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=651&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_46":"http:\/\/count.chanet.com.cn\/click.cgi?a=439743&d=345657&u={pageid}-{blockid}-{otherid}&e={channelid}&url={url}","w_48":"http:\/\/g.yiqifa.com\/gc?w=515194&u=213287&e=a{channelid}b{pageid}c{blockid}d{otherid}&c=17468&v=459141&i=40789&t={url}","w_49":"http:\/\/p.yiqifa.com\/c?s=62718716&w=515194&c=5402&i=11642&l=0&e=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_50":"http:\/\/p.yiqifa.com\/c?s=62718716&w=515194&c=5402&i=11642&l=0&e=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_51":"{url}?tag=it1680f-20","w_54":"http:\/\/p.yiqifa.com\/c?s=c99fb1bf&w=515194&c=6712&i=22762&l=0&e=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_58":"http:\/\/count.chanet.com.cn\/click.cgi?a=439743&d=372533&u={pageid}-{blockid}-{otherid}&e={channelid}&url={url}","w_59":"http:\/\/p.yiqifa.com\/c?s=6f5f2914&w=515194&c=17297&i=39095&l=0&e=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}","w_62":"http:\/\/c.duomai.com\/track.php?site_id=131499&aid=2649&euid=a{channelid}b{pageid}c{blockid}d{otherid}&t={url}"}
var SequelLian = {
    ChannelId: 0, //频道id
    ChannelPageId: 0, //频道页id
    ChannelPageBlockId: 0, //频道页块id
    OtherID: "0",
    DivIds: "", //a标签所在容器编号  div1,div2,div3(与DivClass必传其中一个)
    DivClass: "", //a标签所在容器的class    cls1,cls2,cls3(与DivIds必传其中一个)

    SiteId: 1, //站点id  1.泡泡  2.it168 3.s端
    EBSiteId: 0, //电商编号(由程序中分析链接获取,不用外部传入)
    //下面是clickpv统计用的,谁用谁传
    spid: 0,
    ckpid: 0,
    scid: 0,
    bid: 0,
    pid: 0,
    cpurl: '', //点击到的电商URL,点击时获取
    //根据频道编号获取网站编号
    GetSiteID: function () {
        if (this.ChannelId == 1 || this.ChannelId == 3 || this.ChannelId == 5 || this.ChannelId == 9 || this.ChannelId == 10 || this.ChannelId == 11 || this.ChannelId == 13 || this.ChannelId == 15) {
            this.SiteId = 1;
            return;
        }
        if (this.ChannelId == 2 || this.ChannelId == 4 || this.ChannelId == 6 || this.ChannelId == 7 || this.ChannelId == 8 || this.ChannelId == 14 || this.ChannelId == 20) {
            this.SiteId = 2;
            return;
        }
        if (this.ChannelId == 12 || this.ChannelId == 16 || this.ChannelId == 17 || this.ChannelId == 18 || this.ChannelId == 19 || this.ChannelId == 21 || this.ChannelId == 22 || this.ChannelId == 23) {
            this.SiteId = 3;
            return;
        }
    },
    //初始化对象
    init: function () {
        return this;
    },

    //根据url获取电商编号 返回0时为不匹配电商
    GetEBSite: function (url) {
        //删除这几种形式的反利后再判断
        url = url.replace(/http:\/\/count.chanet.com.cn\/.*?url=/, "");
        url = url.replace(/http:\/\/g.yiqifa.com\/.*?t=/, "");
        url = url.replace(/http:\/\/a.okhqb.com\/plus\/.*?url=/, "");

        url = url.replace(/https:\/\/count.chanet.com.cn\/.*?url=/, "");
        url = url.replace(/https:\/\/g.yiqifa.com\/.*?t=/, "");
        url = url.replace(/https:\/\/a.okhqb.com\/plus\/.*?url=/, "");

        //获取域名
        var m = url.match("^http://(.*?)(?:/|$)");
        if (m == null) {
            m = url.match("^https://(.*?)(?:/|$)");
        }
        if (m != null && m.length > 1) {
            url = m[1];
        }
        //逐个判断
        if (url.indexOf("baomi.com") != -1) {
            this.EBSiteId = 0;
            return;
        }
        if (url.indexOf("jd.com") != -1) {
            if (url.indexOf("z.jd.com") == -1 && url.indexOf("union.click.jd.com") == -1) {
                this.EBSiteId = 1;
                return;
            }
        }
        if (url.indexOf("amazon.cn") != -1 || url.indexOf("z.cn") != -1) {
            this.EBSiteId = 2;
            return;
        }
        if (url.indexOf("suning.com") != -1) {
            this.EBSiteId = 3;
            return;
        }
        if (url.indexOf("gome.com.cn") != -1) {
            this.EBSiteId = 4;
            return;
        }
        if (url.indexOf("51buy.com") != -1 || url.indexOf("yixun.com") != -1) {
            this.EBSiteId = 5;
            return;
        }
        if (url.indexOf("coo8.com") != -1) {
            this.EBSiteId = 6;
            return;
        }
        if (url.indexOf("yidianda.com") != -1) {
            this.EBSiteId = 7;
            return;
        }
        //        if (url.indexOf("taobao.com") != -1 || url.indexOf("tmall.com") != -1) {
        //            this.EBSiteId = 8;
        //            return;
        //        }
        if (url.indexOf("store.apple.com") != -1) {
            this.EBSiteId = 9;
            return;
        }
        if (url.indexOf("mall.10010.com") != -1) {
            this.EBSiteId = 11;
            return;
        }
        if (url.indexOf("tao3c.com") != -1) {
            this.EBSiteId = 12;
            return;
        }
        if (url.indexOf("hicdma.com") != -1) {
            this.EBSiteId = 13;
            return;
        }
        if (url.indexOf("shop.lenovo.com.cn") != -1 || url.indexOf("shop.lenovomobile.com") != -1) {
            this.EBSiteId = 14;
            return;
        }
        if (url.indexOf("xiaomi.com") != -1 || url.indexOf("mi.com") != -1) {
            this.EBSiteId = 16;
            return;
        }

        if (url.indexOf("oppo.com") != -1 || url.indexOf("opposhop.com.cn") != -1) {
            this.EBSiteId = 17;
            return;
        }
        if (url.indexOf("vivo.com.cn") != -1) {
            this.EBSiteId = 18;
            return;
        }
        if (url.indexOf("meizu.com") != -1) {
            this.EBSiteId = 19;
            return;
        }
        if (url.indexOf("www.vmall.com") != -1) {
            this.EBSiteId = 20;
            return;
        }
        if (url.indexOf("shop.ejiayu.com") != -1) {
            this.EBSiteId = 21;
            return;
        }
        if (url.indexOf("microsoftstore.com") != -1) {
            this.EBSiteId = 22;
            return;
        }
        if (url.indexOf("ahongmall.com") != -1) {
            this.EBSiteId = 28;
            return;
        }
        if (url.indexOf("store.logitech.com.cn") != -1) {
            this.EBSiteId = 29;
            return;
        }
        if (url.indexOf("ehaier.com") != -1) {
            this.EBSiteId = 30;
            return;
        }
        if (url.indexOf("dangdang.com") != -1) {
            this.EBSiteId = 31;
            return;
        }
        if (url.indexOf("newegg.com.cn") != -1 || url.indexOf("newegg.cn") != -1) {
            this.EBSiteId = 32;
            return;
        }
        if (url.indexOf("okhqb.com") != -1 || url.indexOf("360hqb.com") != -1) {
            this.EBSiteId = 33;
            return;
        }
        if (url.indexOf("yhd.com") != -1) {
            this.EBSiteId = 34;
            return;
        }
        if (url.indexOf("zm7.cn") != -1) {
            this.EBSiteId = 35;
            return;
        }
        if (url.indexOf("efeihu.com") != -1) {
            this.EBSiteId = 36;
            return;
        }
        if (url.indexOf("new7.com") != -1) {
            this.EBSiteId = 37;
            return;
        }
        if (url.indexOf("dell.com.cn") != -1) {
            this.EBSiteId = 38;
            return;
        }
        if (url.indexOf("1mall.com") != -1) {
            this.EBSiteId = 39;
            return;
        }
        if (url.indexOf("dianping.com") != -1) {
            this.EBSiteId = 40;
            return;
        }
        if (url.indexOf("nuomi.com") != -1) {
            this.EBSiteId = 41;
            return;
        }
        if (url.indexOf("manzuo.com") != -1) {
            this.EBSiteId = 42;
            return;
        }
        if (url.indexOf("lusen.com") != -1) {
            this.EBSiteId = 43;
            return;
        }
        if (url.indexOf("v6shangcheng.com") != -1) {
            this.EBSiteId = 44;
            return;
        }
        if (url.indexOf("shop.letv.com") != -1) {
            this.EBSiteId = 45;
            return;
        }

        if (url.indexOf("coolpad.cn") != -1) {
            this.EBSiteId = 46;
            return;

        }
        if (url.indexOf("shopping1.hp.com") != -1) {
            this.EBSiteId = 47;
            return;

        }
        if (url.indexOf("10086.cn") != -1) {
            this.EBSiteId = 48;
            return;

        }
        if (url.indexOf("meituan.com") != -1) {
            this.EBSiteId = 49;
            return;

        }
        if (url.indexOf("lashou.com") != -1) {
            this.EBSiteId = 50;
            return;
        }
        if (url.indexOf("amazon.com") != -1) {
            this.EBSiteId = 51;
            return;
        }
        if (url.indexOf("sfbest.com") != -1) {
            this.EBSiteId = 54;
            return;
        }
        if (url.indexOf("oneplus.cn") != -1) {
            this.EBSiteId = 55;
            return;
        }
        if (url.indexOf("ztehn.com") != -1) {
            this.EBSiteId = 56;
            return;
        }

        if (url.indexOf("s1.mi.com") != -1 || url.indexOf("p.www.xiaomi.com") != -1) {
            this.EBSiteId = 58;
            return;
        }

        if (url.indexOf("eshop.htc.com") != -1) {
            this.EBSiteId = 59;
            return;
        }

        if (url.indexOf("jump.ztcadx.com") != -1) {//酷宝
            this.EBSiteId = 100;
            return;
        }
        if (url.indexOf("tv.coocaa.com") != -1) {
            this.EBSiteId = 61;
            return;
        }

        if (url.indexOf("microsoftstore.com.cn") != -1) {
            this.EBSiteId = 62;
            return;
        }
        if (url.indexOf("aa7a.cn") != -1) {
            this.EBSiteId = 63;
            return;
        }

        this.EBSiteId = 0;
    },

    //处理链接
    LinkConvert: function (EBProductUrl) {
        //删除原有的返利链接
        if (this.EBSiteId == 2) {
            EBProductUrl = EBProductUrl.replace(/[\?|&]+?tag=.*?(?=$|&)/, "");
        }
        EBProductUrl = EBProductUrl.replace(/http:\/\/cps.gome.com.cn\/home\/.*?to=/, "");
        EBProductUrl = EBProductUrl.replace(/http:\/\/count.chanet.com.cn\/.*?url=/, "");
        EBProductUrl = EBProductUrl.replace(/http:\/\/g.yiqifa.com\/.*?t=/, "")
        EBProductUrl = EBProductUrl.replace(/http:\/\/a.okhqb.com\/plus\/.*?url=/, ""); ;
        //删除原有的返利链接结束
        var TbGoodsId = null;
        if (this.EBSiteId == 2) {
            if (EBProductUrl.toString().indexOf("A1AJ19PSB66TGU") > 0) {
                EBProductUrl = SequelLian.UrlAddParameter(EBProductUrl, "smid", "A1AJ19PSB66TGU");
            }
        }
        try {
            var TempletUrl = rebateurl["w_" + this.EBSiteId];
            if (TempletUrl == null) { return EBProductUrl; }
            if (TempletUrl.toString().indexOf("{url}") == 0) {
                if (EBProductUrl.toString().indexOf("?") != -1) {
                    TempletUrl = TempletUrl.replace("{url}?", "{url}&");
                } else {
                    TempletUrl = TempletUrl.replace("{url}&", "{url}?");
                }
            }
            TempletUrl = TempletUrl.replace(/{url}/g, EBProductUrl).replace(/{ChannelID}/g, this.ChannelId).replace(/{PageID}/g, this.ChannelPageId).replace(/{BlockID}/g, this.ChannelPageBlockId).replace(/{OtherID}/g, this.OtherID);

            return TempletUrl;
        }
        catch (e) {
            return;
        }
    },
    //给一个连接后面追加一个参数
    UrlAddParameter: function (url, key, value) {
        if (url == "") { return ""; }
        if (url.toString().indexOf(key) > 0 && url.toString().indexOf(value) > 0) { return url; }
        if (url.toString().indexOf("?") > 0) {
            url = url + "&";
        } else {
            url = url + "?";
        }
        url = url + key + "=" + value;
        return url;
    },
    //调用胡哥统计签
    EBClick: function () {
        var clickpvtrack = new ClickPvTrack();
        clickpvtrack.cid = this.ChannelId;
        clickpvtrack.cpid = this.ChannelPageId;
        clickpvtrack.pbid = this.ChannelPageBlockId;
        clickpvtrack.bdid = this.EBSiteId;
        clickpvtrack.cpurl = this.cpurl;
        clickpvtrack.spid = this.spid;
        clickpvtrack.ckpid = this.ckpid;//ebb2bproductid
        clickpvtrack.scid = this.scid;//F_SubcategorySN
        clickpvtrack.bid = this.bid;//F_BrandSN
        clickpvtrack.pid = this.pid;//F_ProductSN
        clickpvtrack.track();
    },


    /* 根据元素clsssName得到元素集合
     * @param fatherId 父元素的ID，默认为document
     * @tagName 子元素的标签名
     * @className 用空格分开的className字符串
     */
    getElementsByClassName: function (fatherId, tagName, className) {
        node = fatherId && document.getElementById(fatherId) || document;
        tagName = tagName || "*";
        className = className.split(" ");
        var classNameLength = className.length;
        for (var i = 0, j = classNameLength; i < j; i++) {
            //创建匹配类名的正则
            className[i] = new RegExp("(^|\\s)" + className[i].replace(/\-/g, "\\-") + "(\\s|$)");
        }
        var elements = node.getElementsByTagName(tagName);
        var result = [];
        for (var i = 0, j = elements.length, k = 0; i < j; i++) {//缓存length属性
            var element = elements[i];
            while (className[k++].test(element.className)) {//优化循环
                if (k === classNameLength) {
                    result[result.length] = element;
                    break;
                }
            }
            k = 0;
        }
        return result;
    },
    //传入div集合，获取其中a标签集合
    GetACollectionInDivs: function (divCollection) {
        var ACollection = [];
        for (var i = 0; i < divCollection.length; i++) {
            var contentDiv = divCollection[i];
            if (contentDiv != null) {
                var As = contentDiv.getElementsByTagName("a");
                for (var j = 0; j < As.length; j++) {
                    ACollection.push(As[j]);
                }
            }
        }
        return ACollection;
    },
    //获取指定窗口中的所有链接标签
    GetACollection: function () {
        var ACollection = [];
        if (this.DivIds != "") {
            var divIdCollection = this.DivIds.split(',');
            for (var i = 0; i < divIdCollection.length; i++) {
                var contentDiv = document.getElementById(divIdCollection[i]);
                if (contentDiv != null) {
                    var As = contentDiv.getElementsByTagName("a");
                    for (var j = 0; j < As.length; j++) {
                        ACollection.push(As[j]);
                    }
                }
            }
        }
        if (this.DivClass != "") {
            var divClassCollection = this.DivClass.split(',');
            for (var i = 0; i < divClassCollection.length; i++) {
                var divCollection = this.getElementsByClassName('', '', divClassCollection[i]);
                ACollection = ACollection.concat(this.GetACollectionInDivs(divCollection));
            }
        }
        return ACollection;
    },
    //向无onclick事件的链接标签添加事件
    BindEvent: function () {
        this.GetSiteID(); //通过频道获取网站编号
        var collection = this.GetACollection();
        for (var i = 0; i < collection.length; i++) {
            var a = collection[i];
            this.GetEBSite(a.href); //获取当前电商编号
            if (this.EBSiteId > 0) {

                if (this.ChannelPageId == 216 || this.ChannelPageId == 182 || this.ChannelPageId == 183 || this.ChannelPageId == 180 || this.ChannelPageId == 181) {
                    //移动端的跳转中间页面
                    var linkNew = SequelLian.LinkConvert(a.href);
                    a.setAttribute("href", SequelLian.OpenUrl(this.ChannelId, this.ChannelPageId, this.ChannelPageBlockId, linkNew));
                } else {
                    if (a.onclick != null) { continue; }
                    if (document.all && window.ActiveXObject && !window.opera) {
                        a.attachEvent("onclick", this.GetEventClick(a), false)//IE
                    } else {
                        a.addEventListener("click", this.GetEventClick(a), false)//火狐
                    }
                }

            }
        }
    },
    jsonp: function (args) {
        var jsonp = document.createElement("script");
        jsonp.setAttribute("charset", "utf-8");
        jsonp.setAttribute("type", "text/javascript");
        jsonp.setAttribute("src", args.url);
        jsonp.onload = jsonp.onreadystatechange = function () {
            if (!this.readyState || this.readyState == "loaded" || this.readyState == "complete") {
                if (typeof args.callBack == "function") args.callBack(args.args); //回调函数
                jsonp.onload = jsonp.onreadystatechange = null;
                try { jsonp.parentNode && jsonp.parentNode.removeChild(jsonp); } catch (e) { };
            }
        };
        document.getElementsByTagName("body")[0].appendChild(jsonp);
    },
    //利用闭包实现传入当前对象
    GetEventClick: function (obj) {
        return function () {
            SequelLian.EventClick(obj);
        }
    },
    //向标签添加的事件
    EventClick: function (obj) {
        try {
            var a = obj;
            if (null == a) { return; }
            var orighref = a.getAttribute("_orighref")
            var linkOld = orighref ? orighref : a.href;
            this.GetEBSite(linkOld); //获取当前电商编号
            if (this.EBSiteId > 0) {
                if (this.EBSiteId == 100) {
                    var shopID = a.attributes["shopID"].nodeValue;
                    KBO.ck([shopID, '138', '', '', ''])
                }
                var linkNew = SequelLian.LinkConvert(linkOld);
                var ClickFlag = a.getAttribute("flag");

                if (ClickFlag == null || ClickFlag.length == 0) {
                    a.setAttribute("flag", 1);
                }
                if (this.ChannelPageId != 216 && this.ChannelPageId != 182 && this.ChannelPageId != 183) {
                    if (ClickFlag != 1) {
                        a.href = linkNew ? linkNew : a.href;
                    }
                    this.cpurl = linkOld; //当前链接到的电商链接(统计用)
                    //调用统计签
                    SequelLian.EBClick();
                } else {
                    SequelLian.OpenUrl(this.ChannelId, this.ChannelPageId, this.ChannelPageBlockId, linkNew);
                }
            }
        } catch (k) {
            return;
        }
    },
    OpenUrl: function (channelID, channelPageID, pageblockId, EBProductUrl) {
        //得到页面引用
        var refe = document.referrer;
        try {
            refe = top.document.referrer;
        } catch (e) {
            if (parent) {
                try {
                    refe = parent.document.referrer;
                } catch (e2) {
                    refe = document.referrer;
                }
            }
        }
        var escapeWrapperClickPv = window.encodeURIComponent || escape;
        var request = 'http://open.pcpop.com/OpenUrl.aspx'
            + '?cid=' + channelID
            + '&cpid=' + channelPageID
            + '&pbid=' + pageblockId
            + '&i=' + escapeWrapperClickPv(refe)
            + '&k=' + escapeWrapperClickPv(document.location.href)
            + '&cpurl=' + escapeWrapperClickPv(EBProductUrl);
        return request;
    }
}
